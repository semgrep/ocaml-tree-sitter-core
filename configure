#! /usr/bin/env bash
#
# Create an includable Makefile containing the paths to the tree-sitter
# installation.
#

set -eu

OS=$(uname -s)
if [ "$OS" = "Darwin" ]; then
  # On macOS don't use the local version of tree-sitter since we can't statically link it
  # instead use the system version
  default_prefix=pkg-config tree-sitter --variable=prefix
else
  default_prefix="$(pwd)"/tree-sitter
fi
output_file_mk=tree-sitter-config.mk
output_file_sh=tree-sitter-config.sh

usage() {
  cat <<EOF
Create an includable makefile and an includable shell script
containing variables giving the location of tree-sitter in the
system. Setting these values correctly is important if tree-sitter was
not installed in a standard location.

Output files: $output_file_mk, $output_file_sh

Default locations:
  prefix: $default_prefix
  bindir: \$prefix/bin
  incdir: \$prefix/include
  libdir: \$prefix/lib

Usage: ./configure [options]
Options:
  --bindir DIR
      Absolute path to the folder containing the 'tree-sitter' executable.
  --help
      Show this help message and exit.
  --incdir DIR
      Absolute path to the folder containing the C headers for the
      tree-sitter library.
  --libdir DIR
      Absolute path to the folder containing the compiled tree-sitter
      runtime library.
  --prefix DIR
      Set bindir, incdir, and libdir all at once, relative to this root
      folder, which must be an absolute path.
EOF
}

update_derived_variables() {
  bindir="$prefix"/bin
  incdir="$prefix"/include
  libdir="$prefix"/lib
}

prefix="$default_prefix"
update_derived_variables

while [[ $# -gt 0 ]]; do
  case "$1" in
    --bindir)
      bindir="$2"
      shift
      ;;
    --help)
      usage
      exit 0
      ;;
    --incdir)
      incdir="$2"
      shift
      ;;
    --libdir)
      libdir="$2"
      shift
      ;;
    --prefix)
      prefix="$2"
      update_derived_variables
      shift
      ;;
    *)
      echo "Invalid argument to configure script: $1" >&2
      echo "Try '--help'."
      exit 1
  esac
  shift
done

cat > "$output_file_mk" <<EOF
# Generated by ./configure
#
# Absolute paths to the tree-sitter installation folders.
# This file is meant to be included in makefiles.
#
TREESITTER_BINDIR := $bindir
TREESITTER_INCDIR := $incdir
TREESITTER_LIBDIR := $libdir
PATH := \$(TREESITTER_BINDIR):\$(PATH)
PKG_CONFIG_PATH := \$(TREESITTER_LIBDIR)/pkgconfig:\$(PKG_CONFIG_PATH)
export TREESITTER_BINDIR
export TREESITTER_INCDIR
export TREESITTER_LIBDIR
export PATH
export PKG_CONFIG_PATH
EOF

cat > "$output_file_sh" <<EOF
# Generated by ./configure
#
# Absolute paths to the tree-sitter installation folders.
# This file is meant to be sourced in shell scripts as follows:
#
#   source ./$output_file_sh
#
# or equivalently:
#
#   . ./$output_file_sh
#
TREESITTER_BINDIR="$bindir"
TREESITTER_INCDIR="$incdir"
TREESITTER_LIBDIR="$libdir"
PATH=\$TREESITTER_BINDIR:\$PATH
PKG_CONFIG_PATH=\$TREESITTER_LIBDIR/pkgconfig:\$PKG_CONFIG_PATH
export TREESITTER_BINDIR
export TREESITTER_INCDIR
export TREESITTER_LIBDIR
export PATH
export PKG_CONFIG_PATH
EOF
